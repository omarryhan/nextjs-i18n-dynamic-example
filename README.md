# Next.JS i18n Example

## Why use

- In the spirit of React, each component and page have their own set of translations, instead of declaring them in a global `locales` folder. Each component's translation dir is placed under: `/public/translations/`. So, translations for `components/Title` component, will be found under: `/public/translations/components/Title`. And for the `components/Nested/NestedComponent` will be found under `/public/translations/Nested/NestedComponent` and for `pages/[language]/page-2` will be found under `public/translations/pages/[language]/page-2`

- Support for both: server loaded translations and dynamic translations

- Dynamic translations are cahched using a stale while revlidate cache strategy (using Vercel's [SWR lib](https://github.com/vercel/swr)), so that only the first load will result in a delay. Don't use this example if SEO is a top priority.

- Doesn't block automatic static optimizations

## Why not use

- If you don't want to maintain the all the i18n logic yourself.

- Don't want to write a lot of boilerplate

- I recommend using [next-translate/examples/with-dynamic-routes](https://github.com/vinissimus/next-translate/tree/master/examples/with-dynamic-routes) instead if you find the above points painful enough.

## Files

### 0. `i18n.config.ts`

Example config:

```TS
const allLanguages: Config = {
  en: {
    name: 'English',
    prefix: 'en',
  },
  ar: {
    name: 'العربية',
    prefix: 'ar',
    direction: 'rtl',
  },
};

const defaultLanguage: Language = allLanguages.en;

// used for setting the `hreflang` alternate tag.
// Read the withI18n section for more info.
const domains: Domains = {
  development: 'http://localhost:3000',
  production: 'https://https://next-i18n-dynamic.netlify.app',
};

export default {
  allLanguages,
  defaultLanguage,
  domains
}
```

### 1. `pages/_document.tsx`

Is only there to add the `lang` property in the `html` tag. Note: due to a limitation of Next.JS, the lang property won't change during client side language transitions because the document object is only rendered on the server. For client side html lang transitions, check: `changeDocumentLanguage`.

### 2. `pages/_app.tsx`

Is only there to add a `div` with a `dir` property. e.g. `rtl` and `ltr`. You should define the direction of the languages you specify in `i18n.config.ts`

### 3. `utils/i18n.tsx`

**Has:**

#### `getI18nStaticPaths`

Enumerates `getStaticPaths` with all the lanugage prefixes that you define in your config.

#### `getI18nProps`

Should be used for: `getStaticProps` and `getServerSideProps`.

A simple function that given the language param code generated by: `getI18nStaticPaths` and the component translations needed, loads:

- The language prefix. Returns the default language if no language prefix was given (Shouldn't normally happen).

- The translation namespaces specified, from `public/translations` into memory.

#### `withI18n`

Wraps all the pages that use the `getI18nProps` method. It accepts the props passed by `getI18nProps` and sets them in the `i18nContext` so that all your components can access them using the `useI18n` hook.

This HOC also adds an `hreflang` alternate tag given the page route, e.g.

If you pass the page in `pages/page-2.tsx` to this HOC like this:

```TS
export default withI18n(Page, '/page-2s');
```

It will add the following links to your header.

```jsx
  <link
    rel="alternate"
    href={`http://localhost:3000/en/${pathname}`}  // pathname is '/page-2' in that case
    hrefLang="en"
  />
```

This tag is used to tell search engines which pages are translations of which pages. This is needed because Google claims that the Google crawler doesn't understand path-directories/sub-domains in regards to how they relate to a page's language. (Anyway, stop lying to us Google. We all know that your bots have super intellegence and will be ruling us only in a matter of years).

#### `useI18n`

A hook that given a translation path, returns the translations needed along with:

- the current language prefix
- the current language configs

#### `useDynamicI18n`

Asynchronously loads the translations by doing an ajax call. This will be moved to `useDynamicI18n`. And this will be used to return the proper translations from context. Check: ***components/DynamicTranslations*** for an example.

#### `withPrefetchDynamicTranslations`

To be used with `useDynamicI18n`

A HOC to wrap components that use the `useDynamicI18n` hook. Adds a prefetch header so that the user doesn't have to wait for the component to mount in order to download the translations. This however doesn't entirely solve the latency issue because your page won't show the translations until the components actually mount. That's because SWR can only access the prefetched version when the component mounts and the all the JS has been loaded. This can be useful for large translations and large XHR requests in general. But given the atomicity of the translations in this example, it probably won't make much difference in the latency anyway, because the major latency bottleneck is React, not the translations. NOTE: link prefetch is neither supported on Safari nor Safari IOS.

#### `Link`

Wraps next/link and accepts these extra props:

- language: string of which language you want to redirect to.
- href is optional. If you only pass a language without an href, this link will only switch to the language you chose.

A side effect of this component is that it changes the document's language, when clicked, to the language it redirected to.

Note: Mostly borrowed from next-translate. I would've imported it if it weren't for the fact that next-js call their own hook from within this component.

#### `changeDocumentLanguage`

Given a language prefix on the browser, sets it to \<html>'s lang attribute. Use when changing langugaes. `Link` automatically handles that for you.

#### `setI18nCookie`

Sets a cookie with a name of: `preferred-language` to your cookies. Only works in the browser. See `pages/[language]/index.tsx` to see how this cookie is loaded on the server.

#### `getI18nAgnosticPathname`

Strips the language directory prefix from `window.location.pathname` and returns it. Only works on the browser

#### `getLanguageFromURL`

Opposite of `changeDocumentLanguage`. Strips the language prefix from `window.location.pathname` and returns it. Only works on the browser

## Pain points

1. It's quite cumbersome to list the names of the translations needed for each page. Since all pages already knows which components they will mount, we should expect them to know which translations to load without needing to specify them. I can't think of a clean workaround to solve this problem. Please let me know your thoughts.

2. Redirecting from '/' to '/ar' or '/en' is easy. But what if the user goes to '/page-2' and not '/ar/page-2'. Imo, it should treat it like '/' does and not return a 404.

## Notes

- At first, I tried to store all the translations, in the directory of their respective component, instead of the current approach (having an identical component and pages tree in the `/public` directory). I switched to the current approach due to the following reasons:

  - **Dynamically** importing JSON files as opposed to fetching them via XHR returned a webpack JS module instead of a simple JSON file. This means more payload size. :thumbs-down:. I'm not sure why this was happening, is it a Typescript thing? No clue.

  - I found it hard to dynamically (on the browser) import JSON files using a helper that's located in another directory. e.g. with the `useDynamicI18n` hook, I tried passing it the `__dirname` of the component from the component, but apparantly this feature [isn't](https://nextjs.org/docs/basic-features/data-fetching#reading-files-use-processcwd) [yet](https://github.com/vercel/next.js/issues/8251) [supported](https://github.com/vercel/next.js/issues/10943) by Next.JS. AFAIR, `__dirname` always returned an empty string. Tl;Dr I can't think of a way to dynamically import translations found in the folder of the component. from a helper module, e.g. `utils/i18n.ts`.

## This example builds heavily on the work done in

- [Vinissimus's next-translate](https://github.com/vinissimus/next-translate)
- [Janus Reith's i18n example](https://codesandbox.io/s/nextjs-i18n-staticprops-new-ouyrb)
